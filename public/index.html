<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pipeline Data Processor</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 100%;
      }

      .title {
        color: #333;
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .subtitle {
        color: #666;
        font-size: 1.1em;
        margin-bottom: 40px;
      }

      .process-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 20px 40px;
        font-size: 1.2em;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      }

      .process-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
      }

      .process-btn:active {
        transform: translateY(-1px);
      }

      .process-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .loading {
        display: none;
        margin: 30px 0;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: #667eea;
        font-weight: 600;
      }

      .result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 10px;
        text-align: left;
        display: none;
      }

      .result.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .result.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .result h3 {
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.3);
        padding: 10px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 1.5em;
        font-weight: bold;
        display: block;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.8;
      }

      .file-info {
        background: rgba(255, 255, 255, 0.3);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .logs {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        text-align: left;
        display: none;
      }

      .logs.show {
        display: block;
      }

      .toggle-logs {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 10px;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-success {
        background: #28a745;
      }
      .status-error {
        background: #dc3545;
      }
      .status-processing {
        background: #ffc107;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">üöÄ Pipeline Processor</h1>
      <p class="subtitle">Processe os dados do Pipedrive com um clique</p>

      <button id="processBtn" class="process-btn">Processar Deals</button>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Processando dados do pipeline...</div>
      </div>

      <div id="result" class="result">
        <h3>
          <span id="statusIndicator" class="status-indicator"></span
          ><span id="resultTitle">Resultado</span>
        </h3>
        <div id="resultContent"></div>
        <button id="toggleLogs" class="toggle-logs" style="display: none">
          Ver Logs
        </button>
      </div>

      <div id="logs" class="logs"></div>
    </div>

    <script>
      const processBtn = document.getElementById('processBtn');
      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      const resultTitle = document.getElementById('resultTitle');
      const resultContent = document.getElementById('resultContent');
      const statusIndicator = document.getElementById('statusIndicator');
      const logs = document.getElementById('logs');
      const toggleLogs = document.getElementById('toggleLogs');

      let logMessages = [];

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        const logEntry = `[${timestamp}] ${message}`;
        logMessages.push(logEntry);

        if (logs.classList.contains('show')) {
          updateLogsDisplay();
        }
      }

      function updateLogsDisplay() {
        logs.innerHTML = logMessages.join('\n');
        logs.scrollTop = logs.scrollHeight;
      }

      toggleLogs.addEventListener('click', function () {
        if (logs.classList.contains('show')) {
          logs.classList.remove('show');
          toggleLogs.textContent = 'Ver Logs';
        } else {
          logs.classList.add('show');
          toggleLogs.textContent = 'Ocultar Logs';
          updateLogsDisplay();
        }
      });

      processBtn.addEventListener('click', async function () {
        // Reset
        processBtn.disabled = true;
        processBtn.textContent = 'Processando...';
        loading.style.display = 'block';
        result.style.display = 'none';
        logMessages = [];
        logs.classList.remove('show');
        toggleLogs.style.display = 'none';

        statusIndicator.className = 'status-indicator status-processing';

        addLog('üöÄ Iniciando processamento dos deals...');

        try {
          addLog('üì° Fazendo requisi√ß√£o para /processar-deals');

          const response = await fetch('/processar-deals', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          addLog(`üìä Resposta recebida: ${response.status}`);

          const data = await response.json();

          loading.style.display = 'none';
          result.style.display = 'block';
          toggleLogs.style.display = 'block';

          if (response.ok) {
            // Sucesso
            result.className = 'result success';
            statusIndicator.className = 'status-indicator status-success';
            resultTitle.textContent = 'Processamento Conclu√≠do!';

            addLog('‚úÖ Processamento conclu√≠do com sucesso!');

            let content = `<p><strong>Mensagem:</strong> ${data.message}</p>`;

            if (data.stats) {
              content += `
                            <div class="stats">
                                <div class="stat-item">
                                    <span class="stat-number">${data.stats.totalDeals}</span>
                                    <span class="stat-label">Total Deals</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${data.stats.organizationsFound}</span>
                                    <span class="stat-label">Orgs Encontradas</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${data.stats.organizationsNotFound}</span>
                                    <span class="stat-label">Orgs N√£o Encontradas</span>
                                </div>
                            </div>
                        `;
            }

            if (data.filePath) {
              content += `
                            <div class="file-info">
                                <strong>üìÅ Arquivo Salvo:</strong><br>
                                <code>${data.fileName}</code><br>
                                <small>Localiza√ß√£o: ${data.filePath}</small>
                            </div>
                        `;
              addLog(`üíæ Arquivo salvo: ${data.fileName}`);
            }

            if (data.googleSheets?.url) {
              content += `
                            <div class="file-info">
                                <strong>üìä Google Sheets:</strong><br>
                                <a href="${data.googleSheets.url}" target="_blank">Abrir Planilha</a>
                            </div>
                        `;
              addLog(`üìä Google Sheets criado: ${data.googleSheets.url}`);
            }

            resultContent.innerHTML = content;
          } else {
            // Erro
            result.className = 'result error';
            statusIndicator.className = 'status-indicator status-error';
            resultTitle.textContent = 'Erro no Processamento';

            addLog(`‚ùå Erro: ${data.error || data.message}`);

            resultContent.innerHTML = `
                        <p><strong>Erro:</strong> ${data.message}</p>
                        ${
                          data.error
                            ? `<p><strong>Detalhes:</strong> <code>${data.error}</code></p>`
                            : ''
                        }
                    `;
          }
        } catch (error) {
          loading.style.display = 'none';
          result.style.display = 'block';
          result.className = 'result error';
          statusIndicator.className = 'status-indicator status-error';
          resultTitle.textContent = 'Erro de Conex√£o';
          toggleLogs.style.display = 'block';

          addLog(`üí• Erro de conex√£o: ${error.message}`);

          resultContent.innerHTML = `
                    <p><strong>Erro de conex√£o:</strong></p>
                    <p>N√£o foi poss√≠vel conectar com o servidor. Verifique se o backend est√° rodando.</p>
                    <p><code>${error.message}</code></p>
                `;
        } finally {
          processBtn.disabled = false;
          processBtn.textContent = 'Processar Deals';
          addLog('üèÅ Processo finalizado');
        }
      });

      // Status da conex√£o na inicializa√ß√£o
      window.addEventListener('load', function () {
        addLog('üåê Interface carregada e pronta para uso');
      });
    </script>
  </body>
</html>
